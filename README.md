# Next.js のチュートリアルをやってみる

触ってみたけどめちゃいいぞこれ...

```
"next": "9.3.5",
```

# DEMO

できたのはこれ（マークダウンで記事を管理するブログ）
https://nextjs-tutorial-blog-flax.now.sh/

# セットアップ

```bash
npm init next-app [アプリ名]
cd [アプリ名]
npm run dev
```

# ディレクトリ構造

## 元からあるのはこれだけ

- pages
  - ページそのものを置いておくところ
  - index.js がトップページ
  - あとは好きにディレクトリを切って配置していけば良い
  - `_app.js`は全コンポーネント共通のあれこれをかけるみたい
    - layout 的なやつとは違う
- public
  - 画像などのアセット類を置いておくところ

## チュートリアルで追加したディレクトリ

自分たちでちゃんとルールを作って守りさえすれば好きに作って良さそう

- components
  - 使いまわせるコンポーネントとそれに関連する css を置いておくところ
  - 全画面共通の`layout.js`と`layout.module.css`を置いた
- lib
  - その他の処理をするファイルを置いておくところ
  - データをフェッチしてくるための処理を作っておいたりした
    - `posts.js`
- posts
  - チュートリアルではブログを作ったのでその記事の Markdown ファイルを配置した
- styles
  - グローバルで使いたい css やコンポーネントに依存せずあちこちで使える css などを配置した
    - `global.css`, `utils.module.css`
- pages/api
  - API ルートとして使える

# レンダリング方式

- Static Generation
  - 静的に事前にページを生成しておいて、最低限の js のみクライアント側で動かす
  - パフォーマンスももっとも良く、SEO にもいいのでこれでいけそうな奴は基本これがよい
  - `getStaticProps`を使う
- Server-side Rendering
  - リクエストごとに動的に変わるようなページや、変更頻度が多いページはこれが良い
  - リクエストがきたらサーバー側でレンダリングした結果を返すので静的生成よりも負荷が高いし遅い
  - `getServerSideProps`を使う
- Client-side Rendering
  - データのフェッチが必要じゃない部分だけ先にページを生成して置いて、動的に変えたいところはクライアント側でフェッチしてから書き換える
  - 多分これが一番遅いし、SEO なども弱い
  - 管理画面やダッシュボードなどはこれが有効
    - 値の変更は頻繁だし SEO は気にしなくていいし
  - `SWR`という Next.js 独自の ReactHooks を使う

# デプロイ

Vercel というものを使うと良いらしい。これが最高だった。

## 手順

- github でサインインする
- github リポジトリへのアクセス許可する
- デプロイしたいリポジトリを import する
  - 特に設定は変えずに OK していってよい
- これであとは１分くらい待てば完了

## Next.js が Vercel にデプロイされるとやってくれること

- 静的生成とアセット（js、css、画像、フォントなど）
- サーバーサイドレンダリングと API ルートを使う場合は自動的にサーバーレス関数になり分離される

## 更新手順

これがすごい！

- github リポジトリにプルリクを送る
  - なんとプルリクを送るとその修正を反映した状態のプレビュー URL が閲覧できるようになる
  - 確認して問題なければマージする。そうすると自動で本番もデプロイされる

## TypeScript

- tsconfig.json をルートに作るとビルド時に TypeScript を使うようになる
- tsconfig.json だけだと TypeScript を使うためのライブラリが足りないので別途インストールする(インストールしないとビルドでエラーが出るようになる)
- ビルドを実行すると`next-env.d.ts`というファイルが自動生成されるが、特に触らない

```
npm install --save-dev typescript @types/react @types/node
```

# 今後やりたいこと

- TypeScript
- css 周り
  - scss, style-components, CSS in JS などをどれを使うか
- 環境変数
- プレビュー
- データフェッチ
  - Contentful などのヘッドレス CMS との連携
- Firebase との連携
- PWA
